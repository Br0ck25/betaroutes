name: Security Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Run npm audit (production only)
        run: npm audit --production --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (all dependencies)
        run: npm audit --audit-level=high

      - name: Check for known vulnerabilities
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json || true

          # Parse audit results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json)

          echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "âŒ Security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --summary

          # Fail on GPL licenses (if your project is proprietary)
          # Uncomment if needed:
          # npx license-checker --failOn "GPL;AGPL;LGPL"

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TODO/FIXME comments
        run: |
          echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY

          # Count TODOs and FIXMEs
          TODO_COUNT=$(grep -r "TODO" src/ --include="*.ts" --include="*.svelte" | wc -l || echo "0")
          FIXME_COUNT=$(grep -r "FIXME" src/ --include="*.ts" --include="*.svelte" | wc -l || echo "0")

          echo "- ðŸ“ TODO comments: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ FIXME comments: $FIXME_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Check bundle size
        run: |
          npm run build

          # Get build size
          BUILD_SIZE=$(du -sh .svelte-kit/cloudflare | cut -f1)
          echo "- ðŸ“¦ Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY

  # Optional: SAST (Static Application Security Testing)
  sast:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/javascript
            p/typescript
        env:
          SEMGREP_RULES: |
            rules:
              - id: no-process-env
                pattern: process.env
                message: Use platform.env instead of process.env
                languages: [javascript, typescript]
                severity: ERROR
                paths:
                  include:
                    - src/**
                  exclude:
                    - src/lib/server/**
